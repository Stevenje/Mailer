// Generated by CoffeeScript 1.7.1
var BSON, Db, Server, addRepositories, addToDB, client, db, frequest, getData, getFullProfile, mongo, request, server;

mongo = require("mongodb");

Server = mongo.Server;

Db = mongo.Db;

BSON = mongo.BSONPure;

server = new Server("localhost", 27017, {
  auto_reconnect: true
});

db = new Db("githubdb", server);

db.open(function(err, db) {
  if (!err) {
    return console.log("Connected to 'githubdb' database");
  }
});

request = require("request-json");

frequest = require("request");

client = request.newClient('https://api.github.com/');

getFullProfile = function(profile, callback) {
  var options;
  options = {
    url: profile.url,
    headers: {
      'User-Agent': 'Kontak'
    },
    json: true
  };
  return frequest(options, function(error, responce, body) {
    if (error) {
      return console.log(error);
    } else if (body.email === null) {
      return null;
    } else if (body.email === "") {
      return null;
    } else if (body.site_admin === true) {
      return null;
    } else {
      console.log("getFullProfile: " + body);
      return callback(body);
    }
  });
};

addRepositories = function(user, callback) {
  var options;
  options = {
    url: user.repos_url,
    headers: {
      'User-Agent': 'Kontak'
    },
    json: true
  };
  return frequest(options, function(error, responce, body) {
    if (error) {
      return console.log(error);
    } else {
      user.repos = body;
      console.log("User: " + user);
      return callback(user);
    }
  });
};

addToDB = function(item) {
  return db.collection("profiles", function(err, collection) {
    console.log("Adding GitHub user " + item.login + " to the DB");
    return collection.insert(item, console.log(item), {
      safe: true
    }, function(err, result) {});
  });
};

getData = function(lang, location, page) {
  return client.get('search/users?q=location:' + location + '+language:' + lang + '&page=' + page, function(err, res, body) {
    var profile, profilearray, _i, _len, _results;
    console.log('Total Users found: ' + body.total_count);
    profilearray = body.items;
    _results = [];
    for (_i = 0, _len = profilearray.length; _i < _len; _i++) {
      profile = profilearray[_i];
      _results.push(getFullProfile(profile, function(body) {
        return addRepositories(body, function(item) {
          return addToDB(item);
        });
      }));
    }
    return _results;
  });
};

getData("python", "London", 1);
